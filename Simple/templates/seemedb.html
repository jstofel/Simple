{% extends "content.html" %}

{% block body %}
  <!-- Use the Block Body contents from the parent (content) -->
  {{ super() }}
{% endblock %}

 <!-- Define the Block Viz content here -->
{% block viz %}

  {% if not session.logged_in %}
     <a href="{{ url_for('.login') }}">Log In </a>
  {% else %}
          <!-- a href="{{ url_for('.logout') }}">Log Out </a -->

 <!--Show Form to Choose a Database--> 
  <div>
    <form id="ChooseDatabase"  action="{{ url_for('seemedb', page_id=page_id) }}" method="GET">
            <select  name="database" width="300px">
              {% for o in dbnames %}
	        {% if o[0] == dbname %}
                   <option name="{{ o[0] }}" SELECTED >{{ o[0] }}</option>
	        {% else %}
                   <option name="{{ o[0] }}" >{{ o[0] }}</option>
		{% endif %}
              {% endfor %}
             </select>
              <input class="button1" type="submit" value="Select">
	      <input type = "hidden" name = "page_id" value = {{page_id}} >
    </form>

<!-- If A Database with at Least one Schema with Tables Has Been Chosen, then Show Info About it --> 
{% if numschema > 0 %}      
       <h2 style="font-style:normal" > {{dbname}} </h2>
        <p>Found {{numschema}} schemas, {{num_tables}} tables, and {{num_allFK}} relations</p>

<div id="show_network"  class="border"> &nbsp </div> 

	{% if num_allFK > 0 %}


	<!-- Show the Table -->
	      {{tableDF.to_html()|safe}}
	{% endif %}

  <!-- Show schemas as accordian. Schemas are in a pandas dataframe -->
       {% for index, row in allSchemas.iterrows() %}
         <button class="accordion">{{ row['schema'] }}</button>
	 <div class="panel">
	   {% for index, rowT in allTables.iterrows() %}
	     {% if rowT['schema'] == row['schema'] %}
	       {{ rowT['table'] }} <br>
	     {% endif %}
	   {% endfor %}
	 </div>
       {% endfor %}


 {% endif %}
</div>


  {% endif %}

 {% for message in get_flashed_messages() %}
    <div class="flash">{{ message }}</div>
 {% endfor %}



<script>

var width = 960,
    height = 500;

var color = d3.scale.category20();
/*var color = d3.scaleOrdinal(d3.schemeCategory10);*/

var force = d3.layout.force()
    .charge(-120)
    .linkDistance(30)
    .size([width, height]);

var svg = d3.select("show_network").append("svg")
    .attr("width", width)
    .attr("height", height);

d3.json(JSON.parse({{json_dump|safe}}), function(error, graph) {
  if (error) throw error;

  force
      .nodes(graph.nodes)
      .links(graph.links)
      .start();

  var link = svg.selectAll(".link")
      .data(graph.links)
    .enter().append("line")
      .attr("class", "link")
      .style("stroke-width", function(d) { return Math.sqrt(d.value); });

  var node = svg.selectAll(".node")
      .data(graph.nodes)
    .enter().append("circle")
      .attr("class", "node")
      .attr("r", 5)
      .style("fill", function(d) { return color(d.group); })
      .call(force.drag);

node.append("title")
      .text(function(d) { return d.name; });

  force.on("tick", function() {
    link.attr("x1", function(d) { return d.source.x; })
        .attr("y1", function(d) { return d.source.y; })
        .attr("x2", function(d) { return d.target.x; })
        .attr("y2", function(d) { return d.target.y; });

    node.attr("cx", function(d) { return d.x; })
        .attr("cy", function(d) { return d.y; });
  });
});

</script>



{% endblock %}
